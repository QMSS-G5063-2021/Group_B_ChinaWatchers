---
title: "China's Foreign Direct Investment (FDI)"
output: 
  flexdashboard::flex_dashboard:
    vertical_layout: scroll
    theme: cosmo
---

```{r setup, include=FALSE}
library(flexdashboard)
library(dplyr)
library(tibble)
library(ggplot2)
library(readr)
library(plotly)
library(DT)
library(RColorBrewer)
if(!require(geojsonio)) install.packages("geojsonio", repos = "http://cran.us.r-project.org")
if(!require(leaflet)) install.packages("leaflet", repos = "http://cran.us.r-project.org")
if(!require(RColorBrewer)) install.packages("RColorBrewer", repos = "http://cran.us.r-project.org")

library(geojsonio)
library(leaflet)
library(RColorBrewer)

outflows_filepath <- file.path(getwd(), "data", "Outflows.csv")
df <- read_csv(outflows_filepath)

chinainv_clean_fp <- file.path(getwd(), "data", "chinainv_clean.csv")
chinainv_clean <- read.csv(chinainv_clean_fp)
```

Overview
===================================== 
### Age of Competition?
Tensions between China and the United States continue to make headlines on a frequent basis, and we can continue to expect this mounting tension to continue. On the economic front, the ongoing [US-China Trade War](https://thediplomat.com/2021/03/the-us-china-trade-war-is-still-happening/) is an oft cited consequence of this tension. Through this dashboard, we hope to shed light into another economic frontier of China's continued growth -- their foreign investments to other countries, around the world. 

China's success in establishing itself as a global superpower is contingent on the volume of its foreign direct investment. Beyond being one way that China might continue to gain influence, foreign investments are one key way for China to [garner more strategic resources, which will increase its economic competitiveness](https://thediplomat.com/2020/01/the-investment-war-with-china-assessing-american-pressure/). This causes tension with the United States.

Claims on the volume of foreign investments by China, are best mapped out with data.

In this dashboard, we visualize  **China's growth in outward-oriented foreign investments**. We do this at the level of the entire world, and also at the level of a single continent, Africa, where Chinese Investments have been [on the rise over the years](https://www.forbes.com/sites/earlcarr/2020/09/04/the-us-versus-chinese-investment-in-africa/?sh=2efe223965d4); it is one key part of the world where experts expect [US-China competition to intensify](https://www.cnbc.com/2019/10/09/the-us-china-trade-rivalry-is-underway-in-africa.html).

We hope that by doing so, we are able to map out the contours of Chinese investment activity, which will be useful for observers of China and of US-China relations. 

Please explore each tabs to find out more: 

1. World Map - Where is China investing in? 

2. Yearly Investments by Categories - What is China investing in? 

3. Outgoing FDI - Is China really investing more than the US? 

4. Next Frontier: Africa - What do we know about how China is investing in Africa?

World Map
===================================== 
### Commentary

Where is China investing in? 

This segment displays a world map of the location of China's investments over the years, overall, and by industry, from 2005 to 2020. 

As this is quite an information-rich visualization, a Data Table is appended below for further exploration.



### China's Investment Around the World

```{r Preparing dataset, include=FALSE}
# Preparing dataset
map_filepath <- file.path(getwd(), "data", "china_investments.csv")
df_china_invest = read.csv(map_filepath)
df_china_invest$Quantity.in.Millions = as.numeric(gsub("\\$", "", df_china_invest$Quantity.in.Millions))
df_china_invest_grouped = df_china_invest %>%
  group_by(Country, Sector) %>%
  summarise(Investment_Count=n(),
            amount=sum(Quantity.in.Millions)) %>% 
  filter(!is.na(amount)) %>% 
  mutate(Country = gsub("Russian Federation", "Russia", Country))

df_china_invest_grouped_all = df_china_invest_grouped %>% 
  group_by(Country) %>% 
  summarise(amount=sum(amount))

df_china_invest_grouped_agri = df_china_invest_grouped %>% 
  filter(Sector=='Agriculture') %>% 
  group_by(Country)

df_china_invest_grouped_energy = df_china_invest_grouped %>% 
  filter(Sector=='Energy') %>% 
  group_by(Country)

df_china_invest_grouped_trans = df_china_invest_grouped %>% 
  filter(Sector=='Transport') %>% 
  group_by(Country)

df_china_invest_grouped_chem = df_china_invest_grouped %>% 
  filter(Sector=='Chemicals') %>% 
  group_by(Country)

df_china_invest_grouped_metals = df_china_invest_grouped %>% 
  filter(Sector=='Metals') %>% 
  group_by(Country)

df_china_invest_grouped_util = df_china_invest_grouped %>% 
  filter(Sector=='Utilities') %>% 
  group_by(Country)

df_china_invest_grouped_real = df_china_invest_grouped %>% 
  filter(Sector=='Real estate') %>% 
  group_by(Country)

df_china_invest_grouped_fin = df_china_invest_grouped %>% 
  filter(Sector=='Finance') %>% 
  group_by(Country)

df_china_invest_grouped_tech = df_china_invest_grouped %>% 
  filter(Sector=='Technology') %>% 
  group_by(Country)

df_china_invest_grouped_other = df_china_invest_grouped %>% 
  filter(Sector=='Other') %>% 
  group_by(Country)

df_china_invest_grouped_ent = df_china_invest_grouped %>% 
  filter(Sector=='Entertainment') %>% 
  group_by(Country)

df_china_invest_grouped_logs = df_china_invest_grouped %>% 
  filter(Sector=='Logistics') %>% 
  group_by(Country)
df_china_invest_grouped_fin = df_china_invest_grouped %>% 
  filter(Sector=='Finance') %>% 
  group_by(Country)

df_china_invest_grouped_tour = df_china_invest_grouped %>% 
  filter(Sector=='Tourism') %>% 
  group_by(Country)

df_china_invest_grouped_health = df_china_invest_grouped %>% 
  filter(Sector=='Health') %>% 
  group_by(Country)

map_filepath2 <- file.path(getwd(), "data", "countries.geo.json")
worldcountry = geojson_read(map_filepath2, what = "sp")
```
```{r Building basemap, include=FALSE}
basemap = leaflet(worldcountry, options = leafletOptions(minZoom = 1.25, 
                                                      worldCopyJump=FALSE,
                                                      maxBounds = list(
                                                        list(-90, -180),
                                                        list(90, 180)))) %>% 
  addTiles() %>% 
  addProviderTiles(providers$CartoDB.Positron) %>%
  addLayersControl(
    position='bottomleft',
    baseGroups=c("All", "Agriculture", "Energy", "Transport", "Chemicals", "Metals", "Utilities", "Real estate", "Finance", "Technology", "Other", "Entertainment", "Logistics", "Tourism", "Health"),
    options = layersControlOptions(collapsed = FALSE)) %>% 
  clearBounds()
```
```{r}
# create plotting parameters for map
bins_indiv = c(100, 250, 500, 750, 1000, 1500, 2000, 3000, 5000) 
rb_indiv <- brewer.pal(9, "Reds")
cv_pal_indiv <- colorBin(rb_indiv, bins = bins_indiv)

bins_all = c(100, 500, 1000, 1500, 2500, 4500, 7500, 10000, 25000) 
rb_all <- brewer.pal(9, "Reds")
cv_pal_all <- colorBin(rb_all, bins = bins_all)

# mapping
map = basemap %>%
  #addLegend("bottomright", pal = cv_pal_all, values = df_china_invest_grouped_all$amount, title = "<small>Investment Value (in millions)</small>", group = 'All') %>%
  #addLegend("bottomright", pal = cv_pal_indiv, values = df_china_invest_grouped_agri$amount, title = "<small>Investment Value (in millions)</small>", group = 'Agriculture') %>% 
  #addLegend("bottomright", pal = cv_pal_indiv, values = df_china_invest_grouped_chem$amount, title = "<small>Investment Value (in millions)</small>", group = 'Chemicals') %>% 
  #addLegend("bottomright", pal = cv_pal_indiv, values = df_china_invest_grouped_energy$amount, title = "<small>Investment Value (in millions)</small>", group = 'Energy') %>% 
  #addLegend("bottomright", pal = cv_pal_indiv, values = df_china_invest_grouped_ent$amount, title = "<small>Investment Value (in millions)</small>", group = 'Entertainment') %>% 
  #addLegend("bottomright", pal = cv_pal_indiv, values = df_china_invest_grouped_fin$amount, title = "<small>Investment Value (in millions)</small>", group = 'Finance') %>% 
  #addLegend("bottomright", pal = cv_pal_indiv, values = df_china_invest_grouped_health$amount, title = "<small>Investment Value (in millions)</small>", group = 'Health') %>% 
  #addLegend("bottomright", pal = cv_pal_indiv, values = df_china_invest_grouped_logs$amount, title = "<small>Investment Value (in millions)</small>", group = 'Logistics') %>% 
  #addLegend("bottomright", pal = cv_pal_indiv, values = df_china_invest_grouped_metals$amount, title = "<small>Investment Value (in millions)</small>", group = 'Metals') %>% 
  #addLegend("bottomright", pal = cv_pal_indiv, values = df_china_invest_grouped_other$amount, title = "<small>Investment Value (in millions)</small>", group = 'Other') %>% 
  #addLegend("bottomright", pal = cv_pal_indiv, values = df_china_invest_grouped_real$amount, title = "<small>Investment Value (in millions)</small>", group = 'Real estate') %>% 
  #addLegend("bottomright", pal = cv_pal_indiv, values = df_china_invest_grouped_tech$amount, title = "<small>Investment Value (in millions)</small>", group = 'Technology') %>% 
  #addLegend("bottomright", pal = cv_pal_indiv, values = df_china_invest_grouped_tour$amount, title = "<small>Investment Value (in millions)</small>", group = 'Tourism') %>% 
  #addLegend("bottomright", pal = cv_pal_indiv, values = df_china_invest_grouped_trans$amount, title = "<small>Investment Value (in millions)</small>", group = 'Transport') %>% 
  #addLegend("bottomright", pal = cv_pal_indiv, values = df_china_invest_grouped_util$amount, title = "<small>Investment Value (in millions)</small>", group = 'Utilities') %>% 
  addPolygons(stroke = FALSE,
              smoothFactor = 0.1,
              fillOpacity = 0.8,
              fillColor = ~cv_pal_all(df_china_invest_grouped_all$amount),
              group='All') %>%  
  addPolygons(stroke = FALSE,
              smoothFactor = 0.1,
              fillOpacity = 0.8,
              fillColor = ~cv_pal_indiv(df_china_invest_grouped_agri$amount),
              group='Agriculture') %>% 
  addPolygons(stroke = FALSE,
              smoothFactor = 0.1,
              fillOpacity = 0.8,
              fillColor = ~cv_pal_indiv(df_china_invest_grouped_chem$amount),
              group='Chemicals') %>%
  addPolygons(stroke = FALSE,
              smoothFactor = 0.1,
              fillOpacity = 0.8,
              fillColor = ~cv_pal_indiv(df_china_invest_grouped_energy$amount),
              group='Energy') %>%
  addPolygons(stroke = FALSE,
              smoothFactor = 0.1,
              fillOpacity = 0.8,
              fillColor = ~cv_pal_indiv(df_china_invest_grouped_ent$amount),
              group='Entertainment') %>%
  addPolygons(stroke = FALSE,
              smoothFactor = 0.1,
              fillOpacity = 0.8,
              fillColor = ~cv_pal_indiv(df_china_invest_grouped_fin$amount),
              group='Finance') %>%
  addPolygons(stroke = FALSE,
              smoothFactor = 0.1,
              fillOpacity = 0.8,
              fillColor = ~cv_pal_indiv(df_china_invest_grouped_health$amount),
              group='Health') %>%
  addPolygons(stroke = FALSE,
              smoothFactor = 0.1,
              fillOpacity = 0.8,
              fillColor = ~cv_pal_indiv(df_china_invest_grouped_logs$amount),
              group='Logistics') %>%
  addPolygons(stroke = FALSE,
              smoothFactor = 0.1,
              fillOpacity = 0.8,
              fillColor = ~cv_pal_indiv(df_china_invest_grouped_metals$amount),
              group='Metals') %>%
  addPolygons(stroke = FALSE,
              smoothFactor = 0.1,
              fillOpacity = 0.8,
              fillColor = ~cv_pal_indiv(df_china_invest_grouped_other$amount),
              group='Other') %>%
  addPolygons(stroke = FALSE,
              smoothFactor = 0.1,
              fillOpacity = 0.8,
              fillColor = ~cv_pal_indiv(df_china_invest_grouped_real$amount),
              group='Real estate') %>%
  addPolygons(stroke = FALSE,
              smoothFactor = 0.1,
              fillOpacity = 0.8,
              fillColor = ~cv_pal_indiv(df_china_invest_grouped_tech$amount),
              group='Technology') %>%
  addPolygons(stroke = FALSE,
              smoothFactor = 0.1,
              fillOpacity = 0.8,
              fillColor = ~cv_pal_indiv(df_china_invest_grouped_tour$amount),
              group='Tourism') %>%
  addPolygons(stroke = FALSE,
              smoothFactor = 0.1,
              fillOpacity = 0.8,
              fillColor = ~cv_pal_indiv(df_china_invest_grouped_trans$amount),
              group='Transport') %>%
  addPolygons(stroke = FALSE,
              smoothFactor = 0.1,
              fillOpacity = 0.8,
              fillColor = ~cv_pal_indiv(df_china_invest_grouped_util$amount),
              group='Utilities')

map
```

### China's Investment Around the World (Data)

```{r}
pretty_headers <- 
  gsub("[_]", " ", colnames(df_china_invest_grouped)) %>%
  stringr::str_to_title()

datatable(df_china_invest_grouped,
          colnames = pretty_headers)
```

Yearly Investments by Categories
=====================================
### Overview

What is China investing in? 

The following page displays the yearly amount of Chinese investments overseas from 2005 to 2020. The amounts are sorted by three categories: 1. the ten largest investment destinations, 2. the ten largest Chinese investors and 3. industry sectors. Chinese investments overseas generally reached a peak in the mid-late 2010s, which preceded a slowdown in the following years. The United States is the top investment destination for Chinese investors and the energy sector is consistently the top sector for Chinese investment. There is no one Chinese investor that has dominated Chinese investment overseas.


### Top 10 Investment Destinations

```{r}
CountryYearly <- chinainv_clean %>% 
  group_by(Year, Country) %>% 
  summarise(TotalInvestment = sum(Quantity, na.rm = T),
            .groups = "keep")

byCountry <- CountryYearly %>% 
  group_by(Country) %>% 
  summarise(TotalInvestment = sum(TotalInvestment, na.rm = T)) %>% 
  arrange(desc(TotalInvestment))

top10countries <- byCountry %>% 
  head(10) %>% 
  select(Country) %>% 
  pull()

Top10CountryYearly <- CountryYearly %>% 
  filter(Country %in% top10countries)

countryViz <- Top10CountryYearly %>% 
  ggplot(aes(x = Year, y = TotalInvestment)) +
  geom_line(aes(color = Country)) +
  labs(title = "Chinese Foreign Investments by Top 10 Destinations (2005-2020)",
       y = "Total Investments (in millions USD)") +
  scale_color_brewer(palette = "Paired") +
  ggthemes::theme_tufte() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
        panel.background = element_blank(), axis.line = element_line(colour = "black"))

ggplotly(countryViz)
```

### Top 10 Chinese Investors

```{r}
InvestorYearly <- chinainv_clean %>% 
  group_by(Year, Investor) %>% 
  summarise(TotalInvestment = sum(Quantity, na.rm = T),
            .groups = "keep") 

byInvestor <- chinainv_clean %>% 
  group_by(Investor) %>% 
  summarise(TotalInvestment = sum(Quantity, na.rm=T)) %>% 
  arrange(desc(TotalInvestment))

top10Investors <- byInvestor %>% 
  head(10) %>% 
  select(Investor) %>% 
  pull()

Top10InvestorYearly <- InvestorYearly %>% 
  filter(Investor %in% top10Investors)

investorViz <- Top10InvestorYearly %>% 
  ggplot(aes(x = Year, y = TotalInvestment)) +
  geom_line(aes(color = Investor)) +
  labs(title = "Chinese Foreign Investments by Largest 10 Investors (2005-2020)",
       y = "Total Investments (in millions USD)") +
  ylim(0,20000)+
  ggthemes::theme_tufte() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
        panel.background = element_blank(), axis.line = element_line(colour = "black"))

ggplotly(investorViz)
```

### Chinese Investments by Sector

```{r}
SectorYearly <- chinainv_clean %>% 
  group_by(Year, Sector) %>% 
  summarise(TotalInvestment = sum(Quantity, na.rm = T),
            .groups = "keep") 

bySector <- SectorYearly %>% 
  group_by(Sector) %>% 
  summarise(TotalInvestment = sum(TotalInvestment, na.rm = T)) %>% 
  arrange(desc(TotalInvestment))

nb.cols <- 14
mycolors <- colorRampPalette(brewer.pal(9, "Set1"))(nb.cols)

sectorViz <- SectorYearly %>% 
  ggplot(aes(x = Year, y = TotalInvestment)) +
  labs(title = "Chinese Foreign Investments by Sector (2005-2020)",
       y = "Total Investments (in millions USD)") +
  geom_line(aes(color = Sector)) +
  scale_color_manual(values = mycolors) +
  ggthemes::theme_tufte() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
        panel.background = element_blank(), axis.line = element_line(colour = "black"))
  
ggplotly(sectorViz)
```


Rising Outflows
===================================== 
### FDI Outflows as a percentage of GDP 

Is China really investing more than the US? 

This segment displays line graphs of US and China both seen FDI outflows over the years. Notably, however, one can note how China's rise in FDI outflows have mostly been linear, while the US' seem to fluctuate over time.

Additionally, we can clearly see that China's volume foreign direct investments, as a percentage of their GDP, has recently overtaken that of the United States'. 

### China's Rising FDI Outflows

```{r}
transposed <- as.data.frame(t(as.matrix(df))) #Transpose
 
#get the variables we want#
colnames(transposed) <- transposed[1,]
transposed$year <- rownames(transposed)

transposed <- transposed %>% #moving year to the first
  select(year, everything())

tranposed_new <- transposed[!(rownames(transposed) %in% c('Country Name', 'Country Code')), ]

tranposed_new$`China` <- as.numeric(tranposed_new$`China`)

tranposed_new$`United States` <- as.numeric(tranposed_new$`United States`)

tranposed_new$`year` <- as.numeric(tranposed_new$`year`)

#write.csv(tranposed_new, 'countriesfdi_new.csv')

colors <- c("China" = "red", "United States" = "blue")

china_us_fdi <- ggplot(tranposed_new) + 
  geom_point(aes(x = `year`, y = `China`, color = "China")) +
  geom_smooth(aes(x = `year`, y = `China`, color = "China"), method='loess', se = F) +
  geom_point(aes(x = `year`, y = `United States`, color = "United States")) + 
  stat_smooth(aes(x = `year`, y = `United States`, color = "United States"), method='loess', se = F) + 
  ggthemes::theme_tufte() + 
  labs(
    x = 'Year',
    y = 'FDI Net Outflows (%GDP)',
    title = 'US vs China FDI Outflows (as %GDP)', 
    color = "Legend"
  ) + 
  scale_color_manual(values = colors)

ggplotly(china_us_fdi, tooltip =c("x", "y"))
```


Next Frontier: Africa
===================================== 
### Commentary

What do we know about how China is investing in Africa?
### Global pattern holds in Africa as well

```{r}
# libraries
library(plotly)
library(tidyr)
library(dplyr)
library(ggmap)
library(countrycode)
library(tmap)
library(geojsonio)

# data manipulation
china_africa_stock = readxl::read_xlsx("./data/FDIData_08Jan2021.xlsx", skip=1, n_max=30)
china_africa_stock = china_africa_stock %>% select(where(function(x) !all(is.na(x)))) %>% rename("year"="US$ mn, unadjusted")
china_africa_flow = readxl::read_xlsx("./data/FDIData_08Jan2021.xlsx", skip=1, n_max=30, sheet=2)
china_africa_flow = china_africa_flow %>% select(where(function(x) !all(is.na(x)))) %>% rename("year"="US$ mn, unadjusted")

china_africa = cbind(china_africa_stock["year"], china_africa_stock["Total, US$ bn"], china_africa_flow["Total, US$ bn"])
names(china_africa) = c("year", "stock", "flow")

us_africa = readxl::read_xlsx("./data/FDIData_08Jan2021.xlsx", skip=1, n_max=30, sheet=6)
us_africa = us_africa %>% rename("year"="US$ bn, unadjusted", "flow"="Flows*", "stock"="Stock")


china_africa_long = pivot_longer(china_africa, 2:3, names_to="fdi_type", values_to="investment_amount")
china_africa_long$country="China"

us_africa_long = pivot_longer(us_africa, 2:3, names_to="fdi_type", values_to="investment_amount")
us_africa_long$country="US"

totals = rbind(china_africa_long, us_africa_long)


china_flow_long = china_africa_flow %>% pivot_longer(2:54, names_to="country", values_to="flow_investment") %>%
  filter(!is.na(flow_investment), country!="Regional", country !="Total, US$ mn") %>% select(year, country, flow_investment)

china_stock_long = china_africa_stock %>% pivot_longer(2:54, names_to="country", values_to="stock_investment") %>%
  filter(!is.na(stock_investment), country!="Regional") %>% select(year, country, stock_investment)
china_stock_long$iso = countrycode(china_stock_long$country, origin="country.name", destination="iso3c")

```

 
```{r}
stock_plot = ggplot(filter(totals, fdi_type=="stock", year >=2003), aes(x=year, y=investment_amount, fill=country)) +
  geom_bar(aes(fill=country), stat="identity") +
  ggthemes::theme_tufte() +
  labs(x= "Year", y="Investment amount in billions of USD, unadjusted",
       title="FDI in Africa by Year: Stock") + 
  scale_x_continuous(breaks=2003:2019) + 
  scale_y_continuous(labels=scales::unit_format(unit="b"))

ggplotly(stock_plot)
```


### Same when looking at flow instead of stock

```{r}
flow_plot = ggplot(filter(totals, fdi_type=="flow", year >= 2003), aes(x=year, y=investment_amount, fill=country)) +
  geom_bar(aes(fill=country), stat="identity") +
  ggthemes::theme_tufte() +
  labs(x= "Year", y="Investment amount in billions of USD, unadjusted",
       title="FDI in Africa by Year: Flow") + 
  scale_x_continuous(breaks=2003:2019) +
  scale_y_continuous(labels=scales::unit_format(unit="b"))

ggplotly(flow_plot)
```

### Investment by African country

```{r}
top_10_stock = china_stock_long %>% group_by(country) %>% summarize(max=max(stock_investment)) %>% arrange(desc(max)) %>% head(10) %>% select(country) %>% unlist()
by_country_stock = china_stock_long %>% filter(country %in% top_10_stock) %>%
  plot_ly(x=~year, y=~stock_investment, split=~country, type = "scatter", mode='lines') %>%
  # add_annotations(x=0, y=-.1, xref="paper", yref="paper", text=caption, showarrow=FALSE) %>%
  layout(
    title="Top 10 most invested African countries by year: Stock",
    yaxis=list(title="Investment Amount (US$ million, unadjusted)")
  )
by_country_stock
```

### Zooming in on latest data: 2019 Heatmap

```{r}
china_stock_wide = china_stock_long %>% pivot_wider(id_cols=c(country, iso), names_from=year, values_from="stock_investment")

africa_geo = geojson_read("./data/africa.geo.json", what="sp")
africa_geo@data = africa_geo@data %>% left_join(china_stock_wide, by=c("gu_a3"="iso"))


m = tm_shape(africa_geo) +
  tm_borders() +
  tm_text("country", size = .5) +
  tm_fill("2019", title="Millions USD", convert2density = FALSE) +
  tm_layout(
    main.title="2019 China FDI Heatmap: Stock",
    frame=FALSE
  )
m
```

Data Sources and Repo Link
===================================== 

This is the link to the group's repository: https://github.com/QMSS-G5063-2021/Group_B_ChinaWatchers. The data used in this project was taken from the following sources:

### World Map and Yearly Investments by Categories
https://www.aei.org/china-global-investment-tracker/ 

### Rising Tensions
https://data.worldbank.org/indicator/BM.KLT.DINV.CD.WD?end=2019&start=1970&view=chart

### Next Frontier: Africa
http://www.sais-cari.org/chinese-investment-in-africa

